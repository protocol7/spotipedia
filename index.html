<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">

    <link rel="stylesheet" href="sp://appstore/spotipedia.css">

    <script type="text/javascript" src="sp://appstore/jquery-1.7.1.min.js"></script>
    <script>
      var sp = getSpotifyApi(1);
    	var m = sp.require("sp://import/scripts/api/models")
    	var v = sp.require("sp://import/scripts/api/views")

      sp.trackPlayer.addEventListener("playerStateChanged", function (event) {
       if(event.data.curtrack && !skipReload) {
          console.log("Loading new current playing")
          loadCurrentPlaying()
          skipReload = false
        }
      });


      $(function() {
        loadCurrentPlaying()

        // hack around jsonp only getting invoked once if sync
        setInterval(function() {
          if(pageToLoad) {
            loadPage(pageToLoad)
          }
          pageToLoad = null
        }, 200)
      })

      var pageToLoad
      var skipReload = false

    function loadCurrentPlaying() {
        if(m.player.track) {
          console.log("Player got context")
          if(m.player.track.artists) {
            var artist = m.player.track.artists[0].name
            console.log("Searching wikipedia for artist " + artist)

            search(artist, "artist", function(match) {
              open(match)
            })
          }
        }
    }

    function open(page) {
      pageToLoad = page
    }

    var searchTypes = {
      "artist": ["(artist)", "(band)", "(musician)"],
      "album": ["(album)"]
    }

    function search(term, type, callback) {
      term = term.toLowerCase()
      type = type.toLowerCase()

      console.log("Searching for " + term + " of type " + type)
      $.getJSON("http://en.wikipedia.org/w/api.php?action=opensearch&format=json&limit=500&callback=?", {search:term}, function(data) {
        var results = data[1]
        var typeStrings = searchTypes[type]

        // try finding a match containing a type string
        for(i in results) {
          var result = results[i]
          for(j in typeStrings) {
            var typeString = typeStrings[j]
            if(result.toLowerCase().indexOf(typeString) > 0) {
              console.log("Found match containg search type " + result)
              callback(result)
              return
            }
          }
        }

        // didn't find anything with the search type, try finding an exact match
        for(i in results) {
          var result = results[i]
         if(result.toLowerCase() == term) {
            console.log("Found exact match " + result)
            callback(result)
            return
          }
        }

        // didn't find an exact match, just return the first match, if any
        if(results.length > 0) {
          console.log("Using first match " + results[0])
          callback(results[0])
          return
        } else {
          console.log("No match ")
          // nothing was found, give up
          callback(null)
        }
     })
    }

    function loadPage(page) {
      console.log("Loading page " + page)
      $.getJSON("http://en.wikipedia.org/w/api.php?action=parse&format=json&callback=?&page=" + page, {prop:"text"}, function(data) {
        console.log("Page loaded " + page)
        $("#firstHeading").text(decodeURIComponent(page.replace(/\_/g, " ")))

        window.scrollTo(0, 0)


        var html = data.parse.text["*"]
        html = html.replace(/\/\//g, "http://")

        $("#text").html(html)

        $("#text a").click(function() {
          if($(this).attr("href").indexOf("/wiki") == 0) {
            var page = $(this).attr("href").substr(6)
            console.log("Browsing to page " + page)
            //window.location = "spotify:app:appstore:" + page
            pageToLoad = $(this).attr("href").substr(6)
          }
        })

        $(".infobox .album").each(function() {
          var infobox = $(this).parent().parent().parent()
          var albumElm = $(this)
          var name = albumElm.text()

          var artist = $(".contributor", infobox).text()

          console.log('Searching Spotify for album "' + name + '" with artist "' + artist + '"')
          var s = new m.Search('album:"' + name + '" artist:"' + artist + '"', function(data) {
            m.Album.fromURI(data.results[0].data.uri, function(album) {
              var playing = m.playing && m.player.content == album.data.uri
              var playerClass = playing ? "sp-player-playing" : "sp-player-paused"

              $("a.image", infobox).wrap(function() {
                return '<div class="sp-player ' + playerClass + '" tabindex="0"><div class="sp-player-image">'
                  + '</div><button class="sp-player-button" style="display: block"></button></div>'
              })

              $(".sp-player-button").click(function() {
                var playerDiv = $(this).parent()
                skipReload = true
                if(playerDiv.hasClass("sp-player-paused")) {
                  m.player.play(album.data.tracks[0].uri, album)
                } else {
                  m.player.playing = false
                }

                playerDiv.toggleClass("sp-player-paused")
                playerDiv.toggleClass("sp-player-playing")
              })
            })
          })
       })
      })
    }
    </script>
</head>

<body>
        <div id="content">
          <h1 id="firstHeading" class="firstHeading">Loading...</h1>
				  <div id="siteSub">From Wikipedia, the free encyclopedia</div>

          <div id="text"></div>
        </div>
</body></html>
